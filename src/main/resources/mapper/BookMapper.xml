<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itheima.dao.BookMapper">
    
    <resultMap id="bookMap" type="com.itheima.domain.Book">
        <id column="book_id" property="id"/>
        <result column="book_name" property="name"/>
        <result column="book_isbn" property="isbn"/>
        <result column="book_press" property="press"/>
        <result column="book_author" property="author"/>
        <result column="book_pagination" property="pagination"/>
        <result column="book_price" property="price"/>
        <result column="book_uploadtime" property="uploadTime"/>
        <result column="book_status" property="status"/>
        <result column="book_borrower" property="borrower"/>
        <result column="book_borrowtime" property="borrowTime"/>
        <result column="book_returntime" property="returnTime"/>
    </resultMap>

    <!-- 根据ID查询图书信息 -->
    <select id="findById" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_id = #{id}
    </select>

    <!-- 根据上架时间查询最新上架的图书信息 -->
    <select id="selectNewBooks" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_status != '3'
        ORDER BY book_uploadtime DESC
        LIMIT 5
    </select>


    <!-- 更新图书信息（用于借阅图书） -->
    <update id="updateBook" parameterType="com.itheima.domain.Book">
        UPDATE book
        SET
            book_status = #{status},
            book_borrower = #{borrower},
            book_borrowtime = #{borrowTime},
            book_returntime = #{returnTime}
        WHERE book_id = #{id}
    </update>
    
    <!-- 新增图书 -->
    <insert id="addBook" parameterType="com.itheima.domain.Book">
        insert into book(
        book_id,book_name,book_isbn,book_press,book_author,
        book_pagination,book_price,book_uploadtime,book_status,
        book_borrower,book_borrowtime,book_returntime)
        values (#{id},#{name},#{isbn},#{press},#{author},#{pagination},
        #{price},#{uploadTime},#{status},#{borrower},#{borrowTime},#{returnTime})
    </insert>

    <!-- 编辑图书 -->
    <update id="editBook" parameterType="com.itheima.domain.Book">
        UPDATE book
        SET
            book_name = #{name},
            book_isbn = #{isbn},
            book_press = #{press},
            book_author = #{author},
            book_pagination = #{pagination},
            book_price = #{price},
            book_status = #{status},
            book_borrower = #{borrower},
            book_borrowtime = #{borrowTime},
            book_returntime = #{returnTime}
        WHERE book_id = #{id}
    </update>
    
    <!-- 查询当前用户未归还的图书信息 -->
    <select id="selectMyBorrowed" parameterType="com.itheima.domain.Book" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE (book_status = '1' OR book_status = '2') AND book_borrower = #{borrower}
        <if test="name != null and name != '' and name.trim() != ''">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null and press != '' and press.trim() != ''">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null and author != '' and author.trim() != ''">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
    </select>
    
    <!-- 查询当前用户未归还和所有待确认归还的图书信息（管理员使用） -->
    <select id="selectBorrowed" parameterType="com.itheima.domain.Book" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE (book_status = '1' OR book_status = '2')
        <if test="name != null and name != '' and name.trim() != ''">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null and press != '' and press.trim() != ''">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null and author != '' and author.trim() != ''">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
    </select>

</mapper>